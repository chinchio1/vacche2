<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Dati Allevamento - Milkminder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .container { background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        h1, h2 { color: #2c3e50; }
        h1 { text-align: center; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .upload-section { border: 2px dashed #3498db; padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 8px; background-color: #f8f9fa; }
        .upload-section:hover { background-color: #e8f4fc; }
        button { background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background-color: #2980b9; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .result-section { display: none; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .kpi-card { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 15px; text-align: center; border-left: 4px solid #3498db; }
        .kpi-value { font-size: 24px; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .kpi-label { color: #7f8c8d; font-size: 14px; }
        .error { color: #e74c3c; background-color: #fadbd8; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { color: #27ae60; background-color: #d5f4e6; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Analisi Dati Allevamento - Milkminder</h1>
        
        <div class="upload-section">
            <h2>Carica il file Excel</h2>
            <p>Seleziona il file Excel con i dati dell'allevamento (formato compatibile con Milkminder)</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <br><br>
            <button onclick="loadFile()">Carica e Analizza</button>
        </div>
        
        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="successMessage" class="success" style="display: none;"></div>
        
        <div id="resultSection" class="result-section">
            <h2>Risultati dell'Analisi</h2>
            
            <div class="kpi-grid">
                <div class="kpi-card"><div class="kpi-label">Prezzo per litro di latte</div><div class="kpi-value" id="pricePerLiter">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Totale latte prodotto (lt)</div><div class="kpi-value" id="totalMilkProduced">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Totale valore del latte (€)</div><div class="kpi-value" id="totalMilkValue">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Vacche totali</div><div class="kpi-value" id="totalCows">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Totale concentrati (kg)</div><div class="kpi-value" id="totalConcentrates">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Concentrato/litro (kg/lt)</div><div class="kpi-value" id="concentratePerLiter">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Euro/tonnellata concentrato</div><div class="kpi-value" id="euroPerTonneConcentrate">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Totale euro alimenti (€)</div><div class="kpi-value" id="totalFeedCost">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Totale kg sostanza secca (SS)</div><div class="kpi-value" id="totalDryMatter">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Litri/kg SS</div><div class="kpi-value" id="litersPerKgDM">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Euro/litro alimenti</div><div class="kpi-value" id="euroPerLiterFeed">-</div></div>
                <div class="kpi-card"><div class="kpi-label">IOFC (€)</div><div class="kpi-value" id="iofc">-</div></div>
                <div class="kpi-card"><div class="kpi-label">IOFC per litro (€/lt)</div><div class="kpi-value" id="iofcPerLiter">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Costo alimentare per vacca/giorno (€)</div><div class="kpi-value" id="feedCostPerCowPerDay">-</div></div>
            </div>
            
            <h3>Dettaglio Alimenti</h3>
            <table id="feedDetails">
                <thead>
                    <tr>
                        <th>Alimento</th>
                        <th>Quantità (kg)</th>
                        <th>Sostanza Secca (%)</th>
                        <th>Prezzo (€/ton)</th>
                        <th>Costo (€)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        function loadFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return showError('Per favore seleziona un file Excel.');
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    const extractedData = extractDataFromWorkbook(workbook);
                    calculateAndDisplayResults(extractedData);
                    showSuccess('File analizzato con successo!');
                    document.getElementById('resultSection').style.display = 'block';
                } catch (error) {
                    showError('Errore nella lettura del file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function extractDataFromWorkbook(workbook) {
            // --- Foglio Milkminder ---
            const milkSheet = workbook.Sheets["Milkminder"];
            if (!milkSheet) throw new Error("Foglio 'Milkminder' non trovato.");
            const milkRows = XLSX.utils.sheet_to_json(milkSheet, { header: 1 });
            const milkDetails = {
                milkSold: parseFloat(findValue(milkRows, "Latte venduto")) || 0,
                milkNotSold: parseFloat(findValue(milkRows, "Latte non venduto")) || 0,
                invoiceAmount: parseFloat(findValue(milkRows, "Importo fattura")) || 0
            };

            // --- Foglio Copertina ---
            const herdSheet = workbook.Sheets["Copertina"];
            if (!herdSheet) throw new Error("Foglio 'Copertina' non trovato.");
            const herdRows = XLSX.utils.sheet_to_json(herdSheet, { header: 1 });
            const herdDetails = {
                cowsBeginning: parseInt(findValue(herdRows, "Vacche iniziali")) || 0,
                cowsCalved: parseInt(findValue(herdRows, "Vacche calvate")) || 0,
                heifersCalved: parseInt(findValue(herdRows, "Manze calvate")) || 0,
                cowsSoldDied: parseInt(findValue(herdRows, "Vacche vendute/morte")) || 0,
                cowsEnd: parseInt(findValue(herdRows, "Vacche finali")) || 0,
                cowsInMilkEnd: parseInt(findValue(herdRows, "Vacche in mungitura")) || 0
            };

            // cerca numero di giorni
            let daysInMonth = parseInt(findValue(herdRows, "Giorni")) || 30;

            // --- Foglio Razioni ---
            const feedSheet = workbook.Sheets["Razioni"];
            if (!feedSheet) throw new Error("Foglio 'Razioni' non trovato.");
            const feedRows = XLSX.utils.sheet_to_json(feedSheet, { defval: "" });
            const concentrates = [];
            const forages = [];

            feedRows.forEach(row => {
                const feed = {
                    name: row["Nome alimento"] || "",
                    kgPerAnimal: parseFloat(row["kg per capo"]) || 0,
                    dryMatter: (parseFloat(row["SS"]) || 0) / 100,
                    pricePerTonne: parseFloat(row["€/ton"]) || 0
                };
                const n = feed.name.toLowerCase();
                if (n.includes("mangime") || n.includes("soia") || n.includes("mais") || n.includes("concentrato") || n.includes("grassi") || n.includes("integrazione")) {
                    concentrates.push(feed);
                } else {
                    forages.push(feed);
                }
            });

            return { milkDetails, herdDetails, feedDetails: { daysInMonth, animalsInRation: herdDetails.cowsInMilkEnd, concentrates, forages } };
        }

        function findValue(rows, label) {
            for (const row of rows) {
                if (row[0] && String(row[0]).toLowerCase().includes(label.toLowerCase())) return row[1];
            }
            return null;
        }

        function calculateAndDisplayResults(data) {
            const totalMilkProduced = data.milkDetails.milkSold + data.milkDetails.milkNotSold;
            const pricePerLiter = data.milkDetails.invoiceAmount / data.milkDetails.milkSold;

            let totalConcentrates = 0, totalFeedCost = 0, totalDryMatter = 0;
            data.feedDetails.concentrates.concat(data.feedDetails.forages).forEach(feed => {
                const totalKg = feed.kgPerAnimal * data.feedDetails.animalsInRation * data.feedDetails.daysInMonth;
                totalConcentrates += data.feedDetails.concentrates.includes(feed) ? totalKg : 0;
                totalFeedCost += totalKg * (feed.pricePerTonne / 1000);
                totalDryMatter += totalKg * feed.dryMatter;
            });

            const concentratePerLiter = totalConcentrates / totalMilkProduced;
            const euroPerTonneConcentrate = (totalFeedCost / (totalConcentrates||1)) * 1000;
            const litersPerKgDM = totalMilkProduced / totalDryMatter;
            const euroPerLiterFeed = totalFeedCost / totalMilkProduced;
            const iofc = data.milkDetails.invoiceAmount - totalFeedCost;
            const iofcPerLiter = iofc / totalMilkProduced;
            const feedCostPerCowPerDay = totalFeedCost / (data.herdDetails.cowsInMilkEnd * data.feedDetails.daysInMonth);

            document.getElementById('pricePerLiter').textContent = pricePerLiter.toFixed(3) + ' €/lt';
            document.getElementById('totalMilkProduced').textContent = totalMilkProduced.toLocaleString('it-IT') + ' lt';
            document.getElementById('totalMilkValue').textContent = data.milkDetails.invoiceAmount.toLocaleString('it-IT') + ' €';
            document.getElementById('totalCows').textContent = data.herdDetails.cowsEnd;
            document.getElementById('totalConcentrates').textContent = totalConcentrates.toLocaleString('it-IT') + ' kg';
            document.getElementById('concentratePerLiter').textContent = concentratePerLiter.toFixed(3) + ' kg/lt';
            document.getElementById('euroPerTonneConcentrate').textContent = euroPerTonneConcentrate.toFixed(2) + ' €/t';
            document.getElementById('totalFeedCost').textContent = totalFeedCost.toLocaleString('it-IT') + ' €';
            document.getElementById('totalDryMatter').textContent = totalDryMatter.toLocaleString('it-IT') + ' kg';
            document.getElementById('litersPerKgDM').textContent = litersPerKgDM.toFixed(2) + ' lt/kg SS';
            document.getElementById('euroPerLiterFeed').textContent = euroPerLiterFeed.toFixed(3) + ' €/lt';
            document.getElementById('iofc').textContent = iofc.toLocaleString('it-IT') + ' €';
            document.getElementById('iofcPerLiter').textContent = iofcPerLiter.toFixed(3) + ' €/lt';
            document.getElementById('feedCostPerCowPerDay').textContent = feedCostPerCowPerDay.toFixed(2) + ' €';

            const feedTableBody = document.querySelector('#feedDetails tbody');
            feedTableBody.innerHTML = '';
            data.feedDetails.concentrates.concat(data.feedDetails.forages).forEach(feed => {
                const totalKg = feed.kgPerAnimal * data.feedDetails.animalsInRation * data.feedDetails.daysInMonth;
                const cost = totalKg * (feed.pricePerTonne / 1000);
                feedTableBody.innerHTML += `<tr>
                    <td>${feed.name}</td>
                    <td>${totalKg.toLocaleString('it-IT')}</td>
                    <td>${(feed.dryMatter * 100).toFixed(1)}%</td>
                    <td>${feed.pricePerTonne.toFixed(2)}</td>
                    <td>${cost.toLocaleString('it-IT')}</td>
                </tr>`;
            });
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }
        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>
